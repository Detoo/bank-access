#!/usr/bin/env python
# Copyright (c) The SimpleFIN Team
# See LICENSE for details.

import sys
import argparse
import getpass
from functools import partial

from banka.wrap3 import Wrap3Protocol, wrap3Prompt



#------------------------------------------------------------------------------
# XXX
# This all belongs in a separate place inside the banka package.
# I'll probably move it next time I add a subcommand to banka

def wrap3(args):
    """
    Spawn a process and reroute channel 3 to getpass calls.
    """
    from twisted.internet.task import react
    return react(_wrap3, [args])

def _wrap3(reactor, args):
    prompter = partial(wrap3Prompt, getpass.getpass)
    proto = Wrap3Protocol(prompter, stdout=sys.stdout, stderr=sys.stderr)
    reactor.spawnProcess(proto, args[0], args=args, env=None, childFDs={
            0: 'w',
            1: 'r',
            2: 'r',
            3: 'r',
        })
    def cb(status):
        return
    def eb(status):
        sys.exit(status.value.exitCode)
    return proto.done.addCallbacks(cb, eb)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    subs = parser.add_subparsers(help='sub-command help', dest='command')
    
    wr = subs.add_parser('wr', help='wr help')
    wr.add_argument('args', metavar='arg', nargs='+',
                     help='command-line args')
    args = parser.parse_args()
    if args.command == 'wr':
        wrap3(args.args)

#------------------------------------------------------------------------------